From 18296541250712dff7acbc645b1d1eb68ce96ff1 Mon Sep 17 00:00:00 2001
From: Greg McCarthy <greg@gjmccarthy.co.uk>
Date: Mon, 22 May 2017 14:12:46 +0100
Subject: [PATCH] Fixes to vero3-061

---
 .../cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp |  2 +-
 .../DVDCodecs/Video/DVDVideoCodecAmlogic.cpp       | 22 ++++------------------
 .../DVDCodecs/Video/DVDVideoCodecAmlogic.h         |  1 -
 3 files changed, 5 insertions(+), 20 deletions(-)

diff --git a/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp b/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp
index dc2a22b85b..f42da345ea 100644
--- a/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp
+++ b/xbmc/cores/VideoPlayer/DVDCodecs/Video/AMLCodec.cpp
@@ -1888,7 +1888,7 @@ int CAMLCodec::DequeueBuffer()
   //Driver change from 10 to 0ms latency, throttle here
   std::chrono::time_point<std::chrono::system_clock> now(std::chrono::system_clock::now());
 
-  unsigned int waitTime(10);
+  unsigned int waitTime(25);
 DRAIN:
   if (m_amlVideoFile->IOControl(VIDIOC_DQBUF, &vbuf) < 0)
   {
diff --git a/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecAmlogic.cpp b/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecAmlogic.cpp
index a44b7f27bf..22c4f4361b 100644
--- a/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecAmlogic.cpp
+++ b/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecAmlogic.cpp
@@ -255,8 +255,6 @@ bool CDVDVideoCodecAmlogic::Open(CDVDStreamInfo &hints, CDVDCodecOptions &option
   m_processInfo.SetVideoDeintMethod("hardware");
   m_processInfo.SetVideoDAR(m_hints.aspect);
 
-  m_has_keyframe = false;
-
   CLog::Log(LOGINFO, "%s: Opened Amlogic Codec", __MODULE_NAME__);
   return true;
 FAIL:
@@ -310,24 +308,13 @@ bool CDVDVideoCodecAmlogic::AddData(const DemuxPacket &packet)
       if (!m_bitstream->Convert(pData, iSize))
         return true;
 
-      if (!m_bitstream->CanStartDecode())
-      {
-        CLog::Log(LOGDEBUG, "%s::Decode waiting for keyframe (bitstream)", __MODULE_NAME__);
-        return true;
-      }
       pData = m_bitstream->GetConvertBuffer();
       iSize = m_bitstream->GetConvertSize();
     }
-    else if (!m_has_keyframe && m_bitparser)
-    {
-      if (!m_bitparser->CanStartDecode(pData, iSize))
-      {
-        CLog::Log(LOGDEBUG, "%s::Decode waiting for keyframe (bitparser)", __MODULE_NAME__);
-        return true;
-      }
-      else
-        m_has_keyframe = true;
-    }
+
+    //if (m_bitparser)
+    //  m_bitparser->HasKeyframe(pData, iSize);
+
     FrameRateTracking( pData, iSize, packet.dts, packet.pts);
 
     if (!m_opened)
@@ -351,7 +338,6 @@ void CDVDVideoCodecAmlogic::Reset(void)
 
   m_Codec->Reset();
   m_mpeg2_sequence_pts = 0;
-  m_has_keyframe = false;
   if (m_bitstream && m_hints.codec == AV_CODEC_ID_H264)
     m_bitstream->ResetStartDecode();
 }
diff --git a/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecAmlogic.h b/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecAmlogic.h
index c7661b04b2..0d40873d68 100644
--- a/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecAmlogic.h
+++ b/xbmc/cores/VideoPlayer/DVDCodecs/Video/DVDVideoCodecAmlogic.h
@@ -102,7 +102,6 @@ protected:
   double          m_mpeg2_sequence_pts;
   h264_sequence  *m_h264_sequence;
   double          m_h264_sequence_pts;   
-  bool            m_has_keyframe;
 
   CBitstreamParser *m_bitparser;
   CBitstreamConverter *m_bitstream;
-- 
2.12.0

